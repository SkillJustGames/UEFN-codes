using { /Fortnite.com/Characters }
using { /Fortnite.com/Devices }
using { /Verse.org/Assets }

custom_character := class():

    var PlayerMesh : mesh = Assets.GetMesh("Path/To/Your/CustomMesh") # Custom mesh
    var IdleAnimation : animation_sequence = Assets.GetAnimation("Path/To/IdleAnimation")
    var RunAnimation : animation_sequence = Assets.GetAnimation("Path/To/RunAnimation")
    var IsActive : logic = false  # To track whether customization is active or not

    @editable
    StartTrigger : trigger_device = trigger_device{}
    
    @editable
    StopTrigger : trigger_device = trigger_device{}

    (Player : player).InitCustomCharacter() : void =
        if (FortCharacter := Player.GetFortCharacter[]):
            # Attach custom mesh and hide original player model
            FortCharacter.AttachMesh(PlayerMesh)
            FortCharacter.SetVisibility(false)
            
            # Play idle animation by default
            FortCharacter.PlayAnimation(IdleAnimation)

            # Subscribe to movement events for animations
            FortCharacter.MovementStateChangedEvent().Subscribe(OnMovementStateChanged)

    (FortCharacter : fort_character).RemoveCustomCharacter() : void =
        FortCharacter.SetVisibility(true)  # Restore original player model
        FortCharacter.DetachMesh(PlayerMesh)  # Detach the custom mesh
        FortCharacter.StopAllAnimations()  # Stop any animations

    OnMovementStateChanged<private>(FortCharacter : fort_character, State : movement_state) : void =
        if State = movement_state.Running:
            FortCharacter.PlayAnimation(RunAnimation)
        else:
            FortCharacter.PlayAnimation(IdleAnimation)

    OnBegin<override>()<suspends> : void =
        PlaySpace := GetPlayspace()
        StartTrigger.TriggeredEvent().Subscribe(StartCustomization)
        StopTrigger.TriggeredEvent().Subscribe(StopCustomization)
        for (Player : PlaySpace.GetPlayers()):
            Player.InitCustomCharacter()

    StartCustomization<private>(Agent : agent) : void =
        if Player := player[Agent]:
            IsActive := true
            Player.InitCustomCharacter()

    StopCustomization<private>(Agent : agent) : void =
        if Player := player[Agent]:
            IsActive := false
            if FortCharacter := Player.GetFortCharacter[]:
                FortCharacter.RemoveCustomCharacter()

    OnPlayerAdded<private>(Agent: agent) : void =
        if (Player := player[Agent]):
            Player.InitCustomCharacter()
